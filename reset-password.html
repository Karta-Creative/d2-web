<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Reset Your Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    /* D2 App Styling */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #151515;
      color: #ffffff;
      padding: 2rem;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
    }

    .logo {
      width: 80px;
      height: 80px;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 2rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.5rem;
      width: 100%;
    }

    label {
      display: block;
      color: #999;
      margin-bottom: 0.5rem;
      font-size: 14px;
    }

    input {
      width: 100%;
      height: 50px;
      padding: 0 1rem;
      background-color: #242526;
      border: 1px solid #43DEC2;
      border-radius: 4px;
      color: #ffffff;
      font-size: 16px;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #43DEC2;
    }

    button {
      width: 100%;
      height: 48px;
      background-color: #43DEC2;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .message {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 4px;
      font-size: 14px;
      line-height: 1.4;
      text-align: center;
    }

    .message.error {
      background-color: rgba(255, 0, 0, 0.1);
      color: #ff6b6b;
    }

    .message.success {
      background-color: rgba(67, 222, 194, 0.1);
      color: #43DEC2;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://raw.githubusercontent.com/Karta-Creative/d2-web/refs/heads/main/logo.png" alt="D2 Logo" class="logo">
    <h1>Reset Your Password</h1>

    <div id="status" class="message"></div>

    <form id="resetForm">
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input 
          id="newPassword" 
          name="newPassword" 
          type="password" 
          required 
          placeholder="Enter your new password"
        />
      </div>
      <button id="resetBtn">Update Password</button>
    </form>
  </div>

  <script>
    // 1) Initialize
    const SUPABASE_URL = 'https://xbkphiqrblzbgxpynndc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhia3BoaXFyYmx6Ymd4cHlubmRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNDU1NjYsImV4cCI6MjA1MTgyMTU2Nn0.NRhA1nb3kTzfJyi-9zw5-acni6R6fxJthVTJbBecogk';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById('status');
    const resetBtn = document.getElementById('resetBtn');
    const resetForm = document.getElementById('resetForm');

    // parse tokens from URL
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');

    // 2) Update status function
    function updateStatus(message, isError = false) {
      statusEl.innerText = message;
      statusEl.className = 'message ' + (isError ? 'error' : 'success');
    }

    // 3) Set session if needed
    async function setSessionIfNeeded() {
      if (accessToken && refreshToken) {
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });
        if (error) {
          updateStatus('Error restoring session: ' + error.message, true);
        } else {
          updateStatus('Session restored. You may now update your password.');
        }
      } else {
        updateStatus('Missing tokens in URL hash. Cannot reset password.', true);
        resetBtn.disabled = true;
      }
    }

    // 4) Handle form submission
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submitted!');
      const newPassword = document.getElementById('newPassword').value.trim();
      if (!newPassword) {
        updateStatus('Please enter a new password.', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) {
          updateStatus('Error updating password: ' + error.message, true);
        } else {
          updateStatus('Password updated successfully! You can now close this tab and log in with your new password on the D2 app.');
          resetBtn.disabled = true;
        }
      } catch (err) {
        updateStatus('Exception: ' + err.message, true);
      }
    });

    // 5) Fire on page load
    document.addEventListener('DOMContentLoaded', setSessionIfNeeded);
  </script>
</body>
</html>
