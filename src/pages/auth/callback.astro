---
import { createClient, type EmailOtpType } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const url = new URL(Astro.request.url);
const token_hash = url.searchParams.get('token');
const type = url.searchParams.get('type');

let debugInfo = {
  token_hash,
  type,
  data: null as any,
  error: null as any
};

if (token_hash && type) {
  const { data, error } = await supabase.auth.verifyOtp({
    type: type as EmailOtpType,
    token_hash,
  });
  
  debugInfo.data = data;
  debugInfo.error = error;
  
  if (!error && data?.session) {
    return Astro.redirect(`/update-password#access_token=${data.session.access_token}&refresh_token=${data.session.refresh_token}`);
  }
}
---

<pre style="color: white; padding: 20px;">
  {JSON.stringify(debugInfo, null, 2)}
</pre>

return Astro.redirect('/'); 