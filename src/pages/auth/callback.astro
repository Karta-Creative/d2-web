---
import { createClient, type EmailOtpType } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const url = new URL(Astro.request.url);
const token_hash = url.searchParams.get('token_hash');
const type = url.searchParams.get('type');

if (token_hash && type) {
  const { data, error } = await supabase.auth.verifyOtp({
    type: type as EmailOtpType,
    token_hash,
  });
  
  if (!error && data.session) {
    return Astro.redirect(`/update-password#access_token=${data.session.access_token}&refresh_token=${data.session.refresh_token}`);
  }
}

return Astro.redirect('/'); 